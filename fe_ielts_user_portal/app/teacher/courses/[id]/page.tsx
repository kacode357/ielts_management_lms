"use client";
import{useEffect,useState,useMemo}from"react";import{useRouter,useParams}from"next/navigation";import{cookieUtils}from"@/utils/cookie";import{User}from"@/types/auth";import{Card}from"@/components/ui/Card";import Header from"@/components/Header";import{useMounted}from"@/hooks";import{ArrowLeft,BookOpen}from"lucide-react";import axiosInstance from"@/config/axios.config";import{Course,TeacherMember,StudentMember,MembersPagination}from"@/types/course";import{Schedule}from"@/types/schedule";import toast from"react-hot-toast";import CourseHeader from"./components/CourseHeader";import TabNavigation,{TabType}from"./components/TabNavigation";import OverviewTab from"./components/OverviewTab";import MembersTab from"./components/MembersTab";import ScheduleTab from"./components/ScheduleTab";export default function CourseDetailPage(){const router=useRouter();const params=useParams();const courseId=params.id as string;const mounted=useMounted();const user=useMemo(()=>{if(!mounted)return null;return cookieUtils.getJSON<User>("__usr_x")},[mounted]);const[course,setCourse]=useState<Course|null>(null);const[isLoading,setIsLoading]=useState(true);const[activeTab,setActiveTab]=useState<TabType>("overview");const[teacher,setTeacher]=useState<TeacherMember|null>(null);const[students,setStudents]=useState<StudentMember[]>([]);const[membersPagination,setMembersPagination]=useState<MembersPagination|null>(null);const[isMembersLoading,setIsMembersLoading]=useState(false);const[schedules,setSchedules]=useState<Schedule[]>([]);const[isScheduleLoading,setIsScheduleLoading]=useState(false);useEffect(()=>{if(mounted&&!user){router.push("/login")}},[mounted,user,router]);useEffect(()=>{const fetchCourseDetail=async()=>{if(!user||!courseId)return;try{setIsLoading(true);const response=await axiosInstance.get<{success:boolean;data:{course:Course}}>(`/courses/${courseId}`);if(response.data.success){setCourse(response.data.data.course)}}catch(error){console.error("Fetch course detail error:",error);toast.error("Failed to load course details");router.push("/teacher/courses")}finally{setIsLoading(false)}};fetchCourseDetail()},[user,courseId,router]);useEffect(()=>{const fetchMembers=async()=>{if(activeTab!=="members"||!courseId)return;try{setIsMembersLoading(true);const response=await axiosInstance.get(`/courses/${courseId}/members?page=1&limit=50`);if(response.data.success){setTeacher(response.data.data.teacher);setStudents(response.data.data.students);setMembersPagination(response.data.data.pagination)}}catch(error){console.error("Fetch members error:",error);toast.error("Failed to load course members")}finally{setIsMembersLoading(false)}};fetchMembers()},[activeTab,courseId]);useEffect(()=>{const fetchSchedule=async()=>{if(activeTab!=="schedule"||!courseId)return;try{setIsScheduleLoading(true);const response=await axiosInstance.get(`/schedules/teacher/my-schedule`);if(response.data.success){const courseSchedules=response.data.data.schedules.filter((s:Schedule)=>s.courseId._id===courseId);setSchedules(courseSchedules)}}catch(error){console.error("Fetch schedule error:",error);toast.error("Failed to load schedule")}finally{setIsScheduleLoading(false)}};fetchSchedule()},[activeTab,courseId]);if(!mounted||!user){return(<div className="min-h-screen flex items-center justify-center bg-gray-50"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div></div>)}return(<><Header/><div className="min-h-screen bg-gray-50"><div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6 lg:py-8"><button onClick={()=>router.push("/teacher/courses")}className="group flex items-center gap-2 text-gray-500 hover:text-blue-600 transition-all duration-200 mb-4 sm:mb-6 cursor-pointer"><ArrowLeft className="w-4 h-4 transition-transform duration-200 group-hover:-translate-x-1"/><span className="text-sm font-medium">Back to Courses</span></button>{isLoading&&(<div className="flex justify-center items-center py-12"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div></div>)}{!isLoading&&course&&(<><CourseHeader course={course}/><TabNavigation activeTab={activeTab}onTabChange={setActiveTab}/><div className="bg-white rounded-xl sm:rounded-2xl shadow-sm border border-gray-100 p-3 sm:p-4 lg:p-6">{activeTab==="overview"&&<OverviewTab course={course}onViewMembers={()=>setActiveTab("members")}/>}{activeTab==="members"&&<MembersTab teacher={teacher}students={students}pagination={membersPagination}isLoading={isMembersLoading}/>}{activeTab==="schedule"&&<ScheduleTab schedules={schedules}isLoading={isScheduleLoading}onRefresh={()=>{const fetchSchedule=async()=>{try{setIsScheduleLoading(true);const response=await axiosInstance.get(`/schedules/teacher/my-schedule`);if(response.data.success){const courseSchedules=response.data.data.schedules.filter((s:Schedule)=>s.courseId._id===courseId);setSchedules(courseSchedules)}}catch(error){console.error("Fetch schedule error:",error)}finally{setIsScheduleLoading(false)}};fetchSchedule()}}/>}</div></>)}{!isLoading&&!course&&(<Card className="p-6 sm:p-12 text-center"><BookOpen className="w-12 h-12 sm:w-16 sm:h-16 text-gray-400 mx-auto mb-4"/><p className="text-gray-600">Course not found</p></Card>)}</div></div></>)}
